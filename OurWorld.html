<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Pastel Gradient Web Messaging with Reactions & Media</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #f6d9e7, #b5defc, #baf7e8);
    background-size: 600% 600%;
    animation: gradientShift 15s ease infinite;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #444;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  @keyframes gradientShift {
    0%{background-position:0% 50%;}
    50%{background-position:100% 50%;}
    100%{background-position:0% 50%;}
  }

  #app {
    width: 100%;
    max-width: 900px;
    height: 90vh;
    background: rgba(255 255 255 / 0.85);
    border-radius: 20px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.12);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-height: 600px;
    position: relative;
  }

  /* Login Screen */
  #login-screen {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 0 2rem;
  }
  #login-screen h1 {
    font-weight: 600;
    font-size: 2.5rem;
    color: #6f4a8e;
    margin-bottom: 1rem;
    text-align: center;
  }
  #login-screen form {
    max-width: 400px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
  }
  #login-screen input[type="text"] {
    padding: 15px 20px;
    border: none;
    border-radius: 35px;
    outline: none;
    font-size: 1rem;
    box-shadow: 0 2px 6px rgba(111 74 142 / 0.2);
    transition: box-shadow 0.3s ease;
  }
  #login-screen input[type="text"]:focus {
    box-shadow: 0 4px 12px rgba(111 74 142 / 0.45);
  }
  #login-screen button {
    margin-top: 1.5rem;
    padding: 15px 20px;
    border: none;
    border-radius: 35px;
    background: linear-gradient(135deg, #ffafbd, #ffc3a0);
    color: #333;
    font-weight: 600;
    font-size: 1.1rem;
    cursor: pointer;
    box-shadow: 0 6px 15px rgba(255 175 189 / 0.6);
    transition: background 0.3s ease;
  }
  #login-screen button:hover {
    background: linear-gradient(135deg, #ffc3a0, #ffafbd);
  }
  #login-error {
    margin-top: 1rem;
    color: #d03e3e;
    font-weight: 600;
    text-align: center;
    height: 1.2rem;
  }

  /* Chat Screen */
  #chat-screen {
    display: none;
    flex: 1;
    height: 100%;
    display: flex;
    flex-direction: column;
    min-height: 0; /* allow flex children height to shrink */
  }

  /* Chat header */
  #chat-header {
    background: linear-gradient(135deg, #ffafbd, #ffc3a0);
    padding: 8px 20px;
    color: #42275a;
    font-weight: 700;
    font-size: 1.4rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 3px 6px rgba(255 175 189 / 0.5);
    flex-shrink: 0;
  }
  /* Fix toggle button to be visible on small screens */
  #chat-header #user-panel-toggle {
    display: none;
    border: none;
    background: #42275a;
    color: #ffc3a0;
    border-radius: 30px;
    font-weight: 700;
    font-size: 1.3rem;
    width: 42px;
    height: 42px;
    cursor: pointer;
    margin-right: 10px;
  }
  #chat-header #user-panel-toggle:hover {
    background: #6f4a8e;
  }
  #chat-header #welcome-msg {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 1rem;
  }
  #chat-header button#logout-btn {
    background: #42275a;
    color: #ffc3a0;
    border: none;
    border-radius: 30px;
    padding: 7px 15px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s ease;
    font-size: 0.9rem;
    margin-left: 10px;
  }
  #chat-header button#logout-btn:hover {
    background: #6f4a8e;
  }

  /* Main chat content */
  #chat-main {
    flex: 1;
    display: flex;
    background: #d3cbf7;
    background: linear-gradient(135deg, #d3cbf7, #b8b0f8);
    min-height: 0;
    overflow: hidden;
    position: relative;
  }

  /* Users list and add friend on left */
  #users-panel {
    width: 230px;
    background: #fcefee;
    border-right: 1px solid #ccc;
    display: flex;
    flex-direction: column;
    padding: 15px;
    min-height: 0;
    transition: transform 0.3s ease;
    z-index: 5;
  }
  #users-panel.hidden {
    transform: translateX(-100%);
    position: absolute;
    top: 0; bottom: 0; left: 0;
    box-shadow: 5px 0 12px rgba(0,0,0,0.15);
  }
  #users-panel h2 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 10px;
    text-align: center;
    color: #9e5769;
  }
  #users-list {
    flex: 1;
    overflow-y: auto;
    min-height: 0;
  }
  .user-card {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    cursor: pointer;
    border-radius: 15px;
    padding: 5px;
    transition: background 0.25s ease;
  }
  .user-card:hover {
    background: #ffd4da;
  }
  .user-card.selected {
    background: #ff9aa2;
  }
  .user-avatar {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #ff899a;
    margin-right: 15px;
    cursor: pointer;
    flex-shrink: 0;
    background: #fff;
    transition: border-color 0.3s ease;
  }
  .user-avatar:hover {
    border-color: #ff6b79;
  }
  .user-name {
    font-weight: 600;
    color: #732337;
    font-size: 1rem;
    word-break: break-word;
  }

  #add-friend-section {
    margin-top: 15px;
    border-top: 1px solid #f3bcc5;
    padding-top: 10px;
    text-align: center;
    flex-shrink: 0;
  }
  #add-friend-btn {
    background: #ff899a;
    border: none;
    color: white;
    font-weight: 600;
    padding: 10px 15px;
    cursor: pointer;
    border-radius: 25px;
    box-shadow: 0 3px 12px rgba(255 137 154 / 0.6);
    transition: background 0.3s ease;
    width: 100%;
  }
  #add-friend-btn:hover:not(:disabled) {
    background: #ff6b79;
  }
  #add-friend-btn:disabled {
    background: #ffcccc;
    cursor: default;
  }

  /* Chat messages panel */
  #chat-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
    position: relative;
    background: transparent;
  }
  #message-list {
    flex: 1;
    padding: 15px 20px 20px 20px;
    overflow-y: auto;
    background: rgba(255 255 255 / 0.7);
    min-height: 0;
    word-wrap: break-word;
  }
  .message-item {
    max-width: 70%;
    margin-bottom: 12px;
    padding: 12px 18px;
    border-radius: 25px;
    background: #e1d8f7;
    color: #42275a;
    font-weight: 500;
    font-size: 0.94rem;
    line-height: 1.3;
    position: relative;
    word-wrap: break-word;
    white-space: pre-wrap;
    user-select: text;
    display: flex;
    flex-direction: column;
  }
  .message-item.sent {
    margin-left: auto;
    background: #c7b3f4;
    color: #2d4f6a;
  }
  .message-item .msg-info {
    font-size: 0.7rem;
    font-weight: 400;
    opacity: 0.75;
    margin-top: 5px;
    text-align: right;
  }

  /* Seen icon */
  .seen-indicator {
    display: inline-block;
    vertical-align: middle;
    margin-left: 6px;
    color: #2d4f6a;
    font-size: 1rem;
    opacity: 0.7;
  }
  .seen-indicator svg {
    width: 16px;
    height: 16px;
    fill: currentColor;
  }

  /* Reactions container */
  .reactions-container {
    margin-top: 4px;
    display: flex;
    gap: 6px;
    font-size: 1.2rem;
    user-select: none;
  }
  .reaction-emoji {
    cursor: pointer;
    background: #f3eaff;
    border-radius: 50%;
    padding: 2px 6px;
    box-shadow: 0 1px 3px rgba(111, 74, 142, 0.3);
    transition: background-color 0.3s ease;
    user-select: none;
  }
  .reaction-emoji.self-reaction {
    background: #7a63f4;
    color: white;
    box-shadow: 0 1px 5px rgba(122, 99, 244, 0.9);
  }

  /* Emoji selection popover */
  #emoji-picker {
    position: absolute;
    z-index: 100;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 10px rgba(111, 74, 142, 0.25);
    display: flex;
    padding: 6px 10px;
    gap: 10px;
    user-select: none;
    font-size: 1.8rem;
    cursor: default;
  }
  #emoji-picker span {
    cursor: pointer;
    padding: 4px 7px;
    border-radius: 12px;
    transition: background-color 0.2s ease;
  }
  #emoji-picker span:hover {
    background-color: #d3cbf7;
    color: #42275a;
  }

  /* Media inside messages */
  .message-media {
    margin-top: 6px;
    border-radius: 16px;
    max-width: 300px;
    max-height: 220px;
    object-fit: contain;
    box-shadow: 0 2px 8px rgba(111, 74, 142, 0.2);
    cursor: pointer;
  }
  .message-media.video {
    background: black;
  }

  /* Message input box */
  #message-form {
    padding: 12px 10px 12px 10px;
    background: #fce7f3;
    border-top: 1px solid #ffc5d1;
    display: flex;
    flex-shrink: 0;
    align-items: center;
    gap: 8px;
  }
  #message-input {
    flex: 1;
    padding: 14px 18px;
    font-size: 1.1rem;
    border-radius: 35px;
    border: none;
    box-shadow: 0 2px 5px rgba(255 137 154 / 0.4);
    outline: none;
  }
  #send-btn {
    padding: 14px 18px;
    font-weight: 600;
    background: #7a63f4;
    color: white;
    border: none;
    border-radius: 35px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(122, 99, 244 / 0.7);
    transition: background 0.3s ease;
    min-width: 70px;
  }
  #send-btn:hover {
    background: #5e4eda;
  }
  #upload-media-btn {
    background: #7a63f4;
    color: white;
    border: none;
    border-radius: 35px;
    cursor: pointer;
    padding: 11px 15px;
    font-size: 1.2rem;
    box-shadow: 0 4px 10px rgba(122, 99, 244 / 0.7);
    transition: background 0.3s ease;
    user-select: none;
  }
  #upload-media-btn:hover {
    background: #5e4eda;
  }

  /* Profile picture and file inputs */
  #avatar-upload, #media-upload {
    display: none;
  }

  /* Scrollbar */
  #users-list::-webkit-scrollbar,
  #message-list::-webkit-scrollbar {
    width: 8px;
  }
  #users-list::-webkit-scrollbar-track,
  #message-list::-webkit-scrollbar-track {
    background: #d3cbf7;
    border-radius: 10px;
  }
  #users-list::-webkit-scrollbar-thumb,
  #message-list::-webkit-scrollbar-thumb {
    background: #7a63f4;
    border-radius: 10px;
  }

  /* Responsive: Tablets and Mobile */
  @media (max-width: 700px) {
    #app {
      height: 100vh;
      border-radius: 0;
      max-width: 100vw;
    }
    #users-panel {
      width: 160px;
      padding: 10px;
    }
    .user-avatar {
      width: 42px;
      height: 42px;
      border-width: 2px;
    }
    .user-name {
      font-size: 0.9rem;
    }
    #chat-header {
      padding: 10px 12px;
      font-size: 1.1rem;
    }
  }

  /* Responsive: Mobile phones full screen and fixed message box bottom */
  @media (max-width: 480px) {
    #chat-header #user-panel-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #app {
      width: 100vw;
      max-width: 100vw;
      height: 100vh;
      border-radius: 0;
      display: flex;
      flex-direction: column;
      padding-bottom: 60px;
      position: relative;
      box-shadow: none;
    }
    #chat-main {
      flex-direction: column;
      height: calc(100vh - 56px);
      overflow: hidden;
    }
    #users-panel {
      width: 100%;
      max-height: 40vh;
      border-right: none;
      border-bottom: 1px solid #ccc;
      padding: 10px 15px;
      position: relative;
      transform: translateX(0) !important;
      box-shadow: none !important;
    }
    #users-panel.hidden {
      display: none;
      transform: none !important;
      box-shadow: none !important;
      max-height: 0;
      padding: 0 15px;
    }
    #users-list {
      max-height: calc(40vh - 70px);
      overflow-y: auto;
    }
    #add-friend-section {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #f3bcc5;
    }
    #chat-panel {
      flex: 1;
      height: calc(60vh - 56px);
      position: relative;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }
    #message-list {
      max-height: 100%;
      overflow-y: auto;
      padding: 10px 15px;
      flex: 1;
      min-height: 0;
      word-break: break-word;
    }
    #message-form {
      padding: 10px 15px;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100vw;
      border-top: 1px solid #7a63f4;
      background: rgba(170 160 247 / 0.85);
      display: flex;
      box-shadow: 0 -1px 5px rgba(0,0,0,0.1);
      z-index: 20;
      align-items: center;
      gap: 8px;
    }
    #message-input {
      font-size: 1.1rem;
      padding: 14px 15px;
    }
    #upload-media-btn {
      font-size: 1.4rem;
      padding: 12px 17px;
    }
    #send-btn {
      min-width: 70px;
      padding: 14px 18px;
      font-size: 1rem;
    }
    #chat-header {
      font-size: 1rem;
      padding: 10px 10px;
      justify-content: space-between;
      position: relative;
      flex-shrink: 0;
      height: 56px;
    }
    #chat-header #user-panel-toggle {
      order: -1;
    }
    #chat-header #welcome-msg {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-right: 10px;
    }
  }
</style>
</head>
<body>
<div id="app" tabindex="0">
  <!-- Login Screen -->
  <section id="login-screen">
    <h1>Our World</h1>
    <form id="login-form" autocomplete="off">
      <input type="text" id="username-input" placeholder="Enter your username" required autofocus />
      <button type="submit">Login</button>
    </form>
    <div id="login-error" role="alert"></div>
  </section>

  <!-- Chat Screen -->
  <section id="chat-screen" aria-live="polite" aria-label="Main chat interface">
    <header id="chat-header">
      <button id="user-panel-toggle" aria-label="Toggle user list" title="Toggle users list">&#9776;</button>
      <div id="welcome-msg"><span id="current-user-name"></span></div>
      <button id="logout-btn" title="Logout">Logout</button>
    </header>
    <main id="chat-main">
      <aside id="users-panel" aria-label="User list">
        <h2>Users</h2>
        <div id="users-list"></div>
        <div id="add-friend-section">
          <button id="add-friend-btn" title="Add Friend">Add Friend</button>
        </div>
      </aside>
      <section id="chat-panel" aria-label="Chat messages and input area">
        <div id="message-list" role="log" aria-live="polite" aria-relevant="additions"></div>
        <form id="message-form" autocomplete="off" aria-label="Send message form">
          <button type="button" id="upload-media-btn" title="Upload image or video" aria-label="Upload Image or Video">&#128247;</button>
          <input type="text" id="message-input" placeholder="Type your message here..." aria-label="Message input" />
          <button type="submit" id="send-btn" aria-label="Send message">Send</button>
        </form>
      </section>
    </main>
  </section>

  <!-- Emoji picker popover -->
  <div id="emoji-picker" style="display:none;" aria-label="Emoji reactions picker" role="dialog" tabindex="-1"></div>

  <!-- Hidden file inputs -->
  <input type="file" accept="image/*,video/*" id="media-upload" style="display:none" aria-hidden="true" />
  <input type="file" accept="image/*" id="avatar-upload" style="display:none" aria-hidden="true" />
</div>

<script>
(() => {
  const fixedUsers = [
    { username: 'Jonel Cutamora', cleanName: 'jonel cutamora' },
    { username: 'Laarni Bordaje Oreta-Cutamora', cleanName: 'laarni bordaje oreta-cutamora' }
  ];
  const LS_USERS = 'chat_users';
  const LS_SESSION = 'chat_session';
  const LS_MESSAGES = 'chat_messages';
  const LS_LAST_SEEN = 'chat_last_seen';

  const loginScreen = document.getElementById('login-screen');
  const chatScreen = document.getElementById('chat-screen');
  const loginForm = document.getElementById('login-form');
  const usernameInput = document.getElementById('username-input');
  const loginError = document.getElementById('login-error');
  const currentUserNameElem = document.getElementById('current-user-name');
  const logoutBtn = document.getElementById('logout-btn');
  const userPanelToggle = document.getElementById('user-panel-toggle');

  const usersListElem = document.getElementById('users-list');
  const addFriendBtn = document.getElementById('add-friend-btn');

  const messageForm = document.getElementById('message-form');
  const messageInput = document.getElementById('message-input');
  const messageList = document.getElementById('message-list');

  const avatarUploadInput = document.getElementById('avatar-upload');
  const usersPanel = document.getElementById('users-panel');
  const emojiPicker = document.getElementById('emoji-picker');
  const chatPanel = document.getElementById('chat-panel');
  const uploadMediaBtn = document.getElementById('upload-media-btn');
  const mediaUploadInput = document.getElementById('media-upload');

  let currentUser = null;
  let currentFriend = null;
  let users = [];
  let messagesData = {};
  let lastSeenData = JSON.parse(localStorage.getItem(LS_LAST_SEEN)) || {};

  const emojiSet = ['👍','😂','❤️','😮','😢','👎'];

  function cleanUsername(name) {
    return name.toLowerCase().trim();
  }
  function saveUsers() { localStorage.setItem(LS_USERS, JSON.stringify(users)); }
  function saveMessages() { localStorage.setItem(LS_MESSAGES, JSON.stringify(messagesData)); }
  function saveSession(username) { localStorage.setItem(LS_SESSION, username); }
  function clearSession() { localStorage.removeItem(LS_SESSION); }
  function loadSession() { return localStorage.getItem(LS_SESSION); }
  function saveLastSeen() { localStorage.setItem(LS_LAST_SEEN, JSON.stringify(lastSeenData)); }

  function initStorage() {
    let storedUsers = JSON.parse(localStorage.getItem(LS_USERS));
    if (!storedUsers || !Array.isArray(storedUsers) || storedUsers.length !== fixedUsers.length) {
      storedUsers = fixedUsers.map((u) => ({
        username: u.username,
        cleanName: u.cleanName,
        friends: [],
        avatar: '',
      }));
      localStorage.setItem(LS_USERS, JSON.stringify(storedUsers));
    }
    let storedMessages = JSON.parse(localStorage.getItem(LS_MESSAGES));
    if (!storedMessages || typeof storedMessages !== 'object') {
      storedMessages = {};
      localStorage.setItem(LS_MESSAGES, JSON.stringify(storedMessages));
    }
    lastSeenData = JSON.parse(localStorage.getItem(LS_LAST_SEEN)) || {};
    return { storedUsers, storedMessages };
  }

  function getChatKey(userA, userB) {
    const a = cleanUsername(userA), b = cleanUsername(userB);
    if (a < b) return a + '__' + b;
    return b + '__' + a;
  }

  function updateLastSeen(chatKey) {
    if (!currentUser) return;
    lastSeenData[currentUser] = lastSeenData[currentUser] || {};
    lastSeenData[currentUser][chatKey] = Date.now();
    saveLastSeen();
  }
  function getLastSeen(otherUser, chatKey) {
    if (!otherUser) return 0;
    if (!lastSeenData[otherUser]) return 0;
    return lastSeenData[otherUser][chatKey] || 0;
  }

  loginForm.addEventListener('submit', e => {
    e.preventDefault();
    loginError.textContent = '';
    const inputName = usernameInput.value.trim();
    if (!inputName) {
      loginError.textContent = 'Please enter a username';
      return;
    }
    const foundUser = fixedUsers.find(u => cleanUsername(inputName) === u.cleanName);
    if (!foundUser) {
      loginError.textContent = 'Invalid username';
      return;
    }
    currentUser = foundUser.username;
    saveSession(currentUser);
    showChatScreen();
  });

  function showChatScreen() {
    loginScreen.style.display = 'none';
    chatScreen.style.display = 'flex';
    currentUserNameElem.textContent = currentUser;
    ({ storedUsers: users, storedMessages: messagesData } = initStorage());

    const currentUserData = users.find(u => cleanUsername(u.username) === cleanUsername(currentUser));
    if (!currentUserData) {
      alert('User data missing. Logging out.');
      logout();
      return;
    }

    renderUsersList();
    if (currentFriend) {
      if (!currentUserData.friends.some(f => cleanUsername(f) === cleanUsername(currentFriend))) {
        currentFriend = null;
      }
    }
    if (!currentFriend && currentUserData.friends.length) {
      currentFriend = currentUserData.friends[0];
    }

    updateAddFriendButton();
    renderMessages();

    if (window.innerWidth <= 480) {
      usersPanel.classList.add('hidden');
      userPanelToggle.setAttribute('aria-expanded', 'false');
    } else {
      usersPanel.classList.remove('hidden');
      userPanelToggle.setAttribute('aria-expanded', 'true');
    }
  }

  function renderUsersList() {
    usersListElem.innerHTML = '';
    const currentUserData = users.find(u => cleanUsername(u.username) === cleanUsername(currentUser));
    if (!currentUserData) return;

    currentUserData.friends.forEach(friendUsername => {
      const friendClean = cleanUsername(friendUsername);
      const friendUserData = users.find(u => cleanUsername(u.username) === friendClean);
      if (!friendUserData) return;

      const userCard = document.createElement('div');
      userCard.className = 'user-card';
      userCard.dataset.username = friendUserData.username;
      if (currentFriend && cleanUsername(friendUserData.username) === cleanUsername(currentFriend)) {
        userCard.classList.add('selected');
      }
      userCard.style.cursor = 'pointer';
      userCard.title = `Chat with ${friendUserData.username}`;
      userCard.addEventListener('click', () => {
        if (currentFriend !== friendUserData.username) {
          currentFriend = friendUserData.username;
          renderUsersList();
          renderMessages();
          if (window.innerWidth <= 480) {
            toggleUsersPanel(false);
          }
        }
      });

      const avatarImg = document.createElement('img');
      avatarImg.className = 'user-avatar';
      avatarImg.alt = `${friendUserData.username} profile picture`;
      avatarImg.src = friendUserData.avatar || getDefaultAvatar(friendUserData.username);
      userCard.appendChild(avatarImg);

      const nameSpan = document.createElement('span');
      nameSpan.className = 'user-name';
      nameSpan.textContent = friendUserData.username;
      userCard.appendChild(nameSpan);

      usersListElem.appendChild(userCard);
    });

    const currentUserDataEntry = users.find(u => cleanUsername(u.username) === cleanUsername(currentUser));
    if (currentUserDataEntry) {
      const userCard = document.createElement('div');
      userCard.className = 'user-card';
      userCard.style.cursor = 'default';

      const avatarImg = document.createElement('img');
      avatarImg.className = 'user-avatar';
      avatarImg.alt = `${currentUserDataEntry.username} profile picture`;
      avatarImg.src = currentUserDataEntry.avatar || getDefaultAvatar(currentUserDataEntry.username);
      avatarImg.title = `Edit your profile picture`;
      avatarImg.addEventListener('click', e => {
        e.stopPropagation();
        avatarUploadInput.click();
      });
      userCard.appendChild(avatarImg);

      const nameSpan = document.createElement('span');
      nameSpan.className = 'user-name';
      nameSpan.textContent = currentUserDataEntry.username + " (You)";
      userCard.appendChild(nameSpan);

      usersListElem.insertBefore(userCard, usersListElem.firstChild);
    }
  }

  function isFriend(username) {
    if (!currentUser) return false;
    const currentUserData = users.find(u => cleanUsername(u.username) === cleanUsername(currentUser));
    if (!currentUserData) return false;
    return currentUserData.friends.some(f => cleanUsername(f) === cleanUsername(username));
  }

  function updateAddFriendButton() {
    if (!currentUser) {
      addFriendBtn.disabled = true;
      addFriendBtn.textContent = 'Add Friend';
      return;
    }
    const otherUser = fixedUsers.find(u => cleanUsername(u.cleanName) !== cleanUsername(currentUser));
    if (!otherUser) {
      addFriendBtn.disabled = true;
      addFriendBtn.textContent = 'No users to add';
      return;
    }
    if (isFriend(otherUser.username)) {
      addFriendBtn.disabled = true;
      addFriendBtn.textContent = `Friendship with ${otherUser.username} added`;
    } else {
      addFriendBtn.disabled = false;
      addFriendBtn.textContent = `Add ${otherUser.username} as Friend`;
    }
  }

  addFriendBtn.addEventListener('click', () => {
    if (!currentUser) return;
    const currentUserData = users.find(u => cleanUsername(u.username) === cleanUsername(currentUser));
    if (!currentUserData) return;
    const otherUser = fixedUsers.find(u => cleanUsername(u.cleanName) !== cleanUsername(currentUser));
    if (!otherUser) return;
    if (!isFriend(otherUser.username)) {
      currentUserData.friends.push(otherUser.username);
      const otherUserData = users.find(u => cleanUsername(u.username) === cleanUsername(otherUser.username));
      if (otherUserData && !otherUserData.friends.some(f => cleanUsername(f) === cleanUsername(currentUser))) {
        otherUserData.friends.push(currentUser);
      }
      saveUsers();
      currentFriend = otherUser.username;
      renderUsersList();
      updateAddFriendButton();
      renderMessages();
      if (window.innerWidth <= 480) {
        toggleUsersPanel(false);
      }
    }
  });

  function renderMessages() {
    if (!currentUser || !currentFriend) {
      messageList.innerHTML = '<p style="text-align:center;color:#aaa;margin-top:20px;">No friend selected. Add a friend to start chatting.</p>';
      return;
    }
    const chatKey = getChatKey(currentUser, currentFriend);
    const chatMsgs = messagesData[chatKey] || [];
    messageList.innerHTML = '';
    updateLastSeen(chatKey);
    chatMsgs.forEach((msg, index) => {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message-item';
      if (cleanUsername(msg.sender) === cleanUsername(currentUser)) msgDiv.classList.add('sent');
      msgDiv.dataset.msgIndex = index;
      if(msg.text) {
        const msgTextSpan = document.createElement('span');
        msgTextSpan.textContent = msg.text;
        msgDiv.appendChild(msgTextSpan);
      }
      if(msg.media) {
        if(msg.mediaType && msg.mediaType.startsWith('video')) {
          const video = document.createElement('video');
          video.className = 'message-media video';
          video.src = msg.media;
          video.controls = true;
          video.alt = 'Video message';
          msgDiv.appendChild(video);
        } else if(msg.mediaType && msg.mediaType.startsWith('image')) {
          const img = document.createElement('img');
          img.className = 'message-media';
          img.src = msg.media;
          img.alt = 'Image message';
          msgDiv.appendChild(img);
        }
      }
      const reactionsContainer = document.createElement('div');
      reactionsContainer.className = 'reactions-container';
      if (msg.reactions && typeof msg.reactions === 'object') {
        const emojiUserMap = {};
        Object.entries(msg.reactions).forEach(([username, emoji]) => {
          if (!emojiUserMap[emoji]) emojiUserMap[emoji] = [];
          emojiUserMap[emoji].push(username);
        });
        Object.entries(emojiUserMap).forEach(([emoji, userList]) => {
          const reactionSpan = document.createElement('span');
          reactionSpan.className = 'reaction-emoji';
          if (userList.some(u => cleanUsername(u) === cleanUsername(currentUser))) {
            reactionSpan.classList.add('self-reaction');
          }
          reactionSpan.textContent = emoji;
          const userNamesShort = userList.map(u => {
            const parts = u.split(' ');
            return parts.length > 0 ? parts[0] : u;
          });
          reactionSpan.title = userNamesShort.join(', ');
          reactionSpan.addEventListener('click', e => {
            e.stopPropagation();
            toggleReaction(msgDiv.dataset.msgIndex, emoji);
          });
          reactionsContainer.appendChild(reactionSpan);
        });
      }
      msgDiv.appendChild(reactionsContainer);
      const timeLine = document.createElement('div');
      timeLine.className = 'msg-info';
      const date = new Date(msg.timestamp);
      timeLine.textContent = date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
      if (cleanUsername(msg.sender) === cleanUsername(currentUser)) {
        const lastSeenTS = getLastSeen(currentFriend, chatKey);
        if (lastSeenTS >= msg.timestamp) {
          const seenIcon = document.createElement('span');
          seenIcon.className = 'seen-indicator';
          seenIcon.title = 'Seen by ' + currentFriend;
          seenIcon.innerHTML = `
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/>
              <circle cx="12" cy="12" r="2.5"/>
            </svg>
          `;
          timeLine.appendChild(seenIcon);
        }
      }
      msgDiv.appendChild(timeLine);
      attachMessageHoldHandler(msgDiv);
      messageList.appendChild(msgDiv);
    });
    messageList.scrollTop = messageList.scrollHeight;
  }

  function toggleReaction(msgIndex, emoji) {
    if (!currentUser || currentFriend === null) return;
    const chatKey = getChatKey(currentUser, currentFriend);
    if (!messagesData[chatKey]) return;
    const chatMsgs = messagesData[chatKey];
    if (!chatMsgs[msgIndex]) return;
    chatMsgs[msgIndex].reactions = chatMsgs[msgIndex].reactions || {};
    const currentReaction = chatMsgs[msgIndex].reactions[currentUser];
    if (currentReaction === emoji) {
      delete chatMsgs[msgIndex].reactions[currentUser];
    } else {
      chatMsgs[msgIndex].reactions[currentUser] = emoji;
    }
    saveMessages();
    renderMessages();
    hideEmojiPicker();
  }

  function attachMessageHoldHandler(msgDiv) {
    let holdTimer = null;
    let isTouch = false;

    function showPicker() {
      openEmojiPicker(msgDiv);
    }
    function cancelHold() {
      if (holdTimer) {
        clearTimeout(holdTimer);
        holdTimer = null;
      }
    }
    msgDiv.addEventListener('mousedown', e => {
      if (e.button !== 0) return;
      isTouch = false;
      cancelHold();
      holdTimer = setTimeout(showPicker, 600);
    });
    msgDiv.addEventListener('mouseup', cancelHold);
    msgDiv.addEventListener('mouseleave', cancelHold);

    msgDiv.addEventListener('touchstart', e => {
      isTouch = true;
      cancelHold();
      holdTimer = setTimeout(showPicker, 700);
    }, {passive: true});
    msgDiv.addEventListener('touchend', cancelHold);
    msgDiv.addEventListener('touchcancel', cancelHold);
  }

  function openEmojiPicker(msgDiv) {
    const rect = msgDiv.getBoundingClientRect();
    const appRect = document.getElementById('app').getBoundingClientRect();

    emojiPicker.innerHTML = '';
    emojiPicker.style.display = 'flex';

    emojiSet.forEach(emoji => {
      const span = document.createElement('span');
      span.textContent = emoji;
      span.title = 'React with ' + emoji;
      span.addEventListener('click', e => {
        e.stopPropagation();
        toggleReaction(msgDiv.dataset.msgIndex, emoji);
      });
      emojiPicker.appendChild(span);
    });

    const pickerWidth = emojiPicker.offsetWidth || (emojiSet.length * 30 + 20);
    const pickerHeight = 40;
    let top = rect.top - appRect.top - pickerHeight - 6;
    if (top < 0) top = rect.bottom - appRect.top + 6;

    let left;
    if (msgDiv.classList.contains('sent')) {
      left = rect.right - appRect.left - pickerWidth;
      if (left < 0) left = 0;
    } else {
      left = rect.left - appRect.left;
      if (left + pickerWidth > appRect.width) left = appRect.width - pickerWidth;
    }

    emojiPicker.style.top = top + 'px';
    emojiPicker.style.left = left + 'px';

    emojiPicker.currentMsgDiv = msgDiv;
    emojiPicker.tabIndex = 0;
    emojiPicker.focus();
  }

  function hideEmojiPicker() {
    emojiPicker.style.display = 'none';
    emojiPicker.currentMsgDiv = null;
  }

  document.addEventListener('click', e => {
    if (!emojiPicker.contains(e.target)) {
      hideEmojiPicker();
    }
  });
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      hideEmojiPicker();
    }
  });

  // Fix Enter key input for sending message
  messageInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (messageInput.value.trim()) {
        messageForm.dispatchEvent(new Event('submit'));
      }
    }
  });

  messageForm.addEventListener('submit', e => {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text) return;
    if (!currentFriend) {
      alert('Please select or add a friend to send message!');
      return;
    }
    const chatKey = getChatKey(currentUser, currentFriend);
    if (!messagesData[chatKey]) messagesData[chatKey] = [];
    const newMsg = {
      sender: currentUser,
      text: text,
      timestamp: Date.now(),
      reactions: {}
    };
    messagesData[chatKey].push(newMsg);
    saveMessages();
    messageInput.value = '';
    renderMessages();
  });

  uploadMediaBtn.addEventListener('click', () => {
    mediaUploadInput.value = '';
    mediaUploadInput.click();
  });
  mediaUploadInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    if (!currentFriend) {
      alert('Please select or add a friend to send media!');
      return;
    }
    loadFileAsDataURL(file, dataUrl => {
      const chatKey = getChatKey(currentUser, currentFriend);
      if (!messagesData[chatKey]) messagesData[chatKey] = [];
      const newMsg = {
        sender: currentUser,
        text: '',
        media: dataUrl,
        mediaType: file.type,
        timestamp: Date.now(),
        reactions: {}
      };
      messagesData[chatKey].push(newMsg);
      saveMessages();
      renderMessages();
    });
  });

  function loadFileAsDataURL(file, callback) {
    const reader = new FileReader();
    reader.onload = function(ev) {
      callback(ev.target.result);
    };
    reader.readAsDataURL(file);
  }

  avatarUploadInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(ev) {
      const dataURL = ev.target.result;
      const currentUserData = users.find(u => cleanUsername(u.username) === cleanUsername(currentUser));
      if (currentUserData) {
        currentUserData.avatar = dataURL;
        saveUsers();
        renderUsersList();
      }
    };
    reader.readAsDataURL(file);
    avatarUploadInput.value = '';
  });

  logoutBtn.addEventListener('click', () => {
    logout();
  });
  function logout() {
    currentUser = null;
    currentFriend = null;
    clearSession();
    chatScreen.style.display = 'none';
    loginScreen.style.display = 'flex';
    loginForm.reset();
    loginError.textContent = '';
  }

  function toggleUsersPanel(forceShow) {
    if (typeof forceShow === 'boolean') {
      if (forceShow) {
        usersPanel.classList.remove('hidden');
        userPanelToggle.setAttribute('aria-expanded', 'true');
      } else {
        usersPanel.classList.add('hidden');
        userPanelToggle.setAttribute('aria-expanded', 'false');
      }
    } else {
      if (usersPanel.classList.contains('hidden')) {
        usersPanel.classList.remove('hidden');
        userPanelToggle.setAttribute('aria-expanded', 'true');
      } else {
        usersPanel.classList.add('hidden');
        userPanelToggle.setAttribute('aria-expanded', 'false');
      }
    }
  }
  userPanelToggle.addEventListener('click', () => {
    toggleUsersPanel();
  });
  window.addEventListener('resize', () => {
    if (chatScreen.style.display !== 'flex') return;
    if (window.innerWidth > 480) {
      usersPanel.classList.remove('hidden');
      userPanelToggle.setAttribute('aria-expanded', 'true');
    } else {
      usersPanel.classList.add('hidden');
      userPanelToggle.setAttribute('aria-expanded', 'false');
    }
  });

  window.addEventListener('load', () => {
    const activeUser = loadSession();
    if (activeUser && fixedUsers.some(u => cleanUsername(u.username) === cleanUsername(activeUser))) {
      currentUser = activeUser;
      showChatScreen();
    }
  });
})();
</script>
</body>
</html>
